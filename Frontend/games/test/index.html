<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<title>Phaser Template</title>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/phaser/2.6.2/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
    <script type="text/javascript">

		var Preload = function(game){};
		Preload.prototype = {
			preload: function(){
			    this.game.load.image("betty", "assets/betty.png");
			    this.game.load.image("banana", "assets/banana.png");
			    this.game.load.physics("sprite_physics", "assets/sprite_physics.json");
			},
			create: function(){
				this.game.state.start("Main");
			}
		}

		var Main = function(game){};
		Main.prototype = {
			create: function() {
				var me = this;
				this.timesHit = 0;
		    this.game.stage.backgroundColor = '#fff';
		    this.game.physics.startSystem(Phaser.Physics.P2JS);
		    this.playerCollisionGroup = this.game.physics.p2.createCollisionGroup();
		    this.blockCollisionGroup = this.game.physics.p2.createCollisionGroup();
		    this.bananasCollisionGroup = this.game.physics.p2.createCollisionGroup();
		    this.createBlock();
		    this.createPlayer();
		    this.createRope();
				this.bananas = this.createObjects("banana");
				this.game.input.onDown.add(this.changeRope, this);
				this.createScore();
				//this.game.physics.p2.updateBoundsCollisionGroup();
		    this.timer = game.time.events.loop(2000, function() {
					if (Math.floor(Math.random()*2))
		        me.spawnObjectLeft();
					else
		        me.spawnObjectRight();
		    });
		    this.game.physics.p2.setImpactEvents(true);
			},

			createScore: function() {
			    this.scoreLabel = this.game.add.text((this.game.world.centerX), 100, "0", {font: "100px Arial", fill: "#2e2459"});
			    this.scoreLabel.anchor.setTo(0.5, 0.5);
			    this.scoreLabel.align = 'center';
			},

			createObjects: function(objectName) {
				// Create a group to hold the collision shapes
				var objects = game.add.group();
				objects.enableBody = true;
				objects.physicsBodyType = Phaser.Physics.P2JS;
				objects.createMultiple(40, objectName);

			    objects.forEach(function(child){
			        child.body.clearShapes();
					child.body.loadPolygon('sprite_physics', objectName);
				}, this);

			    return objects;
			},

			update: function() {
			    this.drawRope();
			},

			spawnObjectLeft: function() {
			    var object = this.spawnObject();
			    object.reset(1, 600);
			    object.body.velocity.x = Math.floor(Math.random()*500)+100;
			    object.body.velocity.y = -Math.floor(Math.random()*500)+100;
			},

			spawnObjectRight: function() {
			    var object = this.spawnObject();
			    object.reset(this.game.world.width, 600);
			    object.body.velocity.x = -(Math.floor(Math.random()*500)+100);
			    object.body.velocity.y = -Math.floor(Math.random()*500)+100;
			},

			spawnObject: function() {
			    var object = this.bananas.getFirstDead();
			    object.body.setCollisionGroup(this.bananasCollisionGroup);
			    object.lifespan = 6000;
					object.body.collides([
				        this.playerCollisionGroup,
				        this.bananasCollisionGroup,
					]);
			    return object;
			},

			createBlock: function() {
			    var blockShape = this.game.add.bitmapData(this.game.world.width, 200);
			    blockShape.ctx.rect(0, 0, this.game.world.width, 200);
			    this.block = this.game.add.sprite(0, 0, blockShape);
			    this.game.physics.p2.enable(this.block);
			    this.block.body.static = true;
			    this.block.anchor.setTo(0, 0);
			    this.block.body.setCollisionGroup(this.blockCollisionGroup);
		   	},

			changeRope: function(sprite, pointer) {
			    this.game.physics.p2.removeSpring(this.rope);
			    this.rope = this.game.physics.p2.createSpring(this.block, this.player, 200, 10, 3, [-pointer.x, -pointer.y]);
			    this.ropeAnchorX = pointer.x;
			    this.ropeAnchorY = pointer.y
			},

			createPlayer: function() {
			    this.player = this.game.add.sprite(200, 400, 'betty');
			    // Enable physics, use "true" to enable debug drawing
			    this.game.physics.p2.enable([this.player], false);
			    // Get rid of current bounding box
			    this.player.body.clearShapes();
			    // Add our PhysicsEditor bounding shape
			    this.player.body.loadPolygon("sprite_physics", "betty");
			    // Define the players collision group and make it collide with the block and fruits
			    this.player.body.setCollisionGroup(this.playerCollisionGroup);
			    this.player.body.collides([
			        this.bananasCollisionGroup,
					], this.playerCollision, this);
			},

			createRope: function() {
			    this.ropeBitmapData = game.add.bitmapData(this.game.world.width, this.game.world.height);
			    this.ropeBitmapData.ctx.beginPath();
			    this.ropeBitmapData.ctx.lineWidth = "4";
			    this.ropeBitmapData.ctx.strokeStyle = "#2f7ee6";
			    this.ropeBitmapData.ctx.stroke();
			    this.line = game.add.sprite(0, 0, this.ropeBitmapData);
			    this.ropeAnchorX = (this.block.world.x + 500);
			    this.ropeAnchorY = (this.block.world.y + this.block.height);

			    this.rope = this.game.physics.p2.createSpring(
			        this.block,  // sprite 1
			        this.player, // sprite 2
			        300,       // length of the rope
			        10,        // stiffness
			        3,         // damping
			        [-(this.block.world.x + 500), -(this.block.world.y + this.block.height)]
			    );
			    this.line = new Phaser.Line(this.player.x, this.player.y,
			        (this.block.world.x + 500), (this.block.world.y + this.block.height));
			},

			drawRope: function() {
			    this.ropeBitmapData.clear();
			    this.ropeBitmapData.ctx.beginPath();
			    this.ropeBitmapData.ctx.beginPath();
			    this.ropeBitmapData.ctx.moveTo(this.player.x, this.player.y);
			    this.ropeBitmapData.ctx.lineTo(this.ropeAnchorX, this.ropeAnchorY);
			    this.ropeBitmapData.ctx.lineWidth = 4;
			    this.ropeBitmapData.ctx.stroke();
			    this.ropeBitmapData.ctx.closePath();
			    this.ropeBitmapData.render();
		    },

		    playerCollision: function() {
			    if(!this.hitCooldown) {
			        this.hitCooldown = true;
			        this.timesHit++;
			        this.scoreLabel.text = this.timesHit;
			        this.game.time.events.add(1000, function(){
			            this.hitCooldown = false;
			        }, this);
			    }
				}
		}

		var Boot = function(game){};
		Boot.prototype = {
			preload: function(){},
	  	create: function(){
				this.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
				this.game.state.start("Preload");
			}
		}

		var GameTitle = function(game){};
		GameTitle.prototype = {
			create: function(){
			},
			startGame: function(){
				this.game.state.start("Main");
			}
		}

		game = new Phaser.Game(window.innerWidth * window.devicePixelRatio, window.innerHeight * window.devicePixelRatio, Phaser.AUTO);

		game.state.add("Boot", Boot);
		game.state.add("Preload", Preload);
		game.state.add("GameTitle", GameTitle);
		game.state.add("Main", Main);
		game.state.start("Boot");



    </script>
</head>
<body>
</body>
</html>
